<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Produtos - Espetão do Léo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #6B73FF 0%, #000DFF 100%);
            min-height: 100vh;
        }
        .glass-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        input, select {
            background: rgba(255, 255, 255, 0.2) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            color: white !important;
        }
        input::placeholder {
            color: rgba(255, 255, 255, 0.6) !important;
        }
        option {
            background-color: #764ba2;
        }
        .sortable-ghost {
            opacity: 0.5;
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0.95);
        }
        
        .categoria-handle:hover {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        
        .produto-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        .cursor-move {
            cursor: grab;
        }
        
        .cursor-move:active {
            cursor: grabbing;
        }
    </style>
</head>
<body class="p-4 md:p-8 text-white">

    <header class="mb-12 glass-container rounded-2xl p-6 max-w-6xl mx-auto">
        <div class="flex items-center justify-center">
            <i class="fas fa-boxes-stacked text-white text-3xl mr-4"></i>
            <h1 class="text-4xl font-bold text-white text-center">Gestão de Produtos</h1>
        </div>
        <p class="text-center text-white/80 mt-2">Adicione categorias e produtos ao seu cardápio.</p>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8 max-w-6xl mx-auto">

        <div class="lg:col-span-1 space-y-8">

            <div class="glass-container rounded-2xl p-6">
                <h2 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-drumstick-bite mr-3"></i>Adicionar/Atualizar Produto</h2>
                <form id="form-produto" action="/adicionar_produto" method="POST" class="space-y-4">
                    <input type="hidden" id="id_produto" name="id_produto">
                    <div>
                        <label for="nome_produto" class="block mb-2 font-semibold">Nome do Produto</label>
                        <input type="text" id="nome_produto" name="nome_produto" placeholder="Ex: Espeto de Carne" class="w-full p-2 rounded-lg">
                    </div>
                    <div>
                        <label for="categoria_produto" class="block mb-2 font-semibold">Categoria</label>
                        <select id="categoria_produto" name="categoria_produto" class="w-full p-2 rounded-lg">
                            {% for categoria in categorias %}
                            <option value="{{ categoria.id }}">{{ categoria.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="preco_venda" class="block mb-2 font-semibold">Preço Venda (R$)</label>
                            <input type="number" step="0.01" id="preco_venda" name="preco_venda" placeholder="10.00" class="w-full p-2 rounded-lg">
                        </div>
                        <div>
                            <label for="preco_compra" class="block mb-2 font-semibold">Preço Compra (R$)</label>
                            <input type="number" step="0.01" id="preco_compra" name="preco_compra" placeholder="4.50" class="w-full p-2 rounded-lg">
                        </div>
                    </div>
                    <div>
                        <label for="quantidade" class="block mb-2 font-semibold">Quantidade</label>
                        <input type="number" id="quantidade" name="quantidade" placeholder="100" class="w-full p-2 rounded-lg">
                    </div>
                    <div id="dica-quantidade" class="hidden p-3 bg-blue-900/50 border border-blue-400 rounded-lg text-sm text-blue-200 space-y-2">
                        <p>
                            <i class="fas fa-info-circle mr-2"></i><strong>Você está fazendo um ajuste de estoque:</strong>
                        </p>
                        <ul class="list-disc list-inside pl-2">
                            <li><strong>Para registrar uma PERDA:</strong> Mantenha o "Preço Compra" como <strong>0</strong>. O custo médio do produto irá aumentar.</li>
                            <li><strong>Para CORRIGIR um erro de entrada:</strong> Insira o "Preço Compra" <strong>original</strong> da entrada errada. O sistema irá reverter o custo.</li>
                        </ul>
                    </div>
                    <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 font-bold py-3 rounded-lg transition-colors">Salvar Produto</button>
                </form>
            </div>

            <div class="glass-container rounded-2xl p-6">
                <h2 class="text-2xl font-bold mb-4 flex items-center"><i class="fas fa-tags mr-3"></i>Gerenciar Categorias</h2>
                
                <form action="/adicionar_categoria" method="POST" class="space-y-4 mb-6">
                    <div>
                        <label for="nome_categoria" class="block mb-2 font-semibold">Nova Categoria</label>
                        <input type="text" id="nome_categoria" name="nome_categoria" placeholder="Ex: Espetinhos" class="w-full p-2 rounded-lg">
                    </div>
                    <button type="submit" class="w-full bg-green-500 hover:bg-green-600 font-bold py-3 rounded-lg transition-colors">Salvar Categoria</button>
                </form>
            
                <hr class="border-white/20 my-4">
            
                <h3 class="text-lg font-semibold mb-3">Categorias Atuais:</h3>
                <ul class="space-y-2 max-h-40 overflow-y-auto pr-2">
                    {% for categoria in categorias %}
                    <li class="flex justify-between items-center bg-white/10 p-2 rounded-lg">
                        <span>{{ categoria.nome }}</span>
                        
                        <a href="{{ url_for('rota_excluir_categoria', id_categoria=categoria.id) }}" title="Excluir Categoria">
                            <button class="text-red-500 hover:text-red-400">
                                <i class="fas fa-trash"></i>
                            </button>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            
        </div>

        <div class="lg:col-span-2 glass-container rounded-2xl p-6 space-y-6">
            <h2 class="text-2xl font-bold flex items-center"><i class="fas fa-list-ul mr-3"></i>Produtos Cadastrados</h2>
            
            <!-- Container para arrastar categorias -->
            <div id="categorias-container">
                {% for categoria_nome, categoria_data in produtos_agrupados.items() %}
                {% if categoria_data.produtos %}
                    <!-- Bloco de categoria arrastável COM ID -->
                    <div class="categoria-bloco mb-6 p-4 bg-white/5 rounded-lg" 
                         data-categoria-id="{{ categoria_data.id }}"
                         data-categoria-nome="{{ categoria_nome }}">
                        
                        <!-- Título da categoria (handle para arrastar) -->
                        <div class="categoria-handle cursor-move">
                            <h3 class="text-xl font-semibold mb-3 border-b-2 border-white/20 pb-2 flex items-center">
                                <i class="fas fa-grip-vertical mr-2 text-white/50"></i>
                                {{ categoria_nome }}
                            </h3>
                        </div>
        
                        <!-- Container de produtos dentro da categoria -->
                        <div class="produtos-container space-y-2">
                            {% for produto in categoria_data.produtos %}
                            <div class="produto-item p-3 bg-white/10 rounded-lg cursor-move" 
                                data-id="{{ produto.id }}"
                                data-nome="{{ produto.nome }}"
                                data-categoria-id="{{ produto.categoria_id }}"
                                data-preco-venda="{{ produto.preco_venda }}"
                                data-preco-compra="{{ produto.ultimo_preco_compra }}">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <i class="fas fa-grip-vertical text-white/50"></i>
                                        <div>
                                            <div class="font-semibold">{{ produto.nome }}</div>
                                            <div class="text-sm text-white/70">
                                                Venda: R$ {{ "%.2f"|format(produto.preco_venda) | replace('.', ',') }} | 
                                                Custo Médio: R$ {{ "%.2f"|format(produto.custo_medio) | replace('.', ',') }} |                                                
                                                Lucro: R$ {{ "%.2f"|format(produto.lucro) | replace('.', ',') }} | 
                                                Estoque: {{ produto.estoque }}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-3">
                                        <a href="#" title="Editar / Adicionar Estoque" class="btn-editar text-yellow-400 hover:text-yellow-300 transition-colors">
                                            <i class="fas fa-pencil-alt"></i>
                                        </a>
                                        <a href="#" title="Ver Histórico de Compras" class="btn-historico text-blue-400 hover:text-blue-300 transition-colors">
                                            <i class="fas fa-history"></i>
                                        </a>
                                        <a href="{{ url_for('rota_excluir_produto', id_produto=produto.id) }}" title="Excluir Produto" class="text-red-500 hover:text-red-400">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </main>
    {# INÍCIO DOS NOVOS SCRIPTS PARA DRAG-AND-DROP #}
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- TUDO AGORA ACONTECE AQUI DENTRO, APÓS O HTML CARREGAR ---

    // --- LÓGICA DA DICA DINÂMICA DE QUANTIDADE (NOVO) ---
    const campoQuantidade = document.getElementById('quantidade');
    const dicaContainer = document.getElementById('dica-quantidade');

    if (campoQuantidade && dicaContainer) {
        campoQuantidade.addEventListener('input', function() {
            // Pega o valor e converte para número
            const valor = parseFloat(campoQuantidade.value);

            // Se o valor for um número e for negativo, mostra a dica
            if (!isNaN(valor) && valor < 0) {
                dicaContainer.classList.remove('hidden');
            } else {
                // Caso contrário, esconde a dica
                dicaContainer.classList.add('hidden');
            }
        });
    }

    // --- LÓGICA DO MODAL (MOVIDA PARA CÁ) ---
    const modal = document.getElementById('modal-historico');
    const modalTitulo = document.getElementById('modal-titulo');
    const modalCorpo = document.getElementById('modal-corpo');
    const btnFechar = document.getElementById('modal-fechar');

    // Esta função agora pode encontrar o 'modal' sem erro.
    function fecharModal() {
        modal.classList.add('hidden');
    }

    // Estes listeners agora são adicionados a elementos que com certeza existem.
    btnFechar.addEventListener('click', fecharModal);
    modal.addEventListener('click', function(event) {
        if (event.target === modal) {
            fecharModal();
        }
    });

    // --- LÓGICA DO 'ARRASTAR E SOLTAR' (JÁ ESTAVA CORRETA) ---
    function enviarNovaOrdem(tipo, idsOrdenados) {
        fetch('/atualizar_ordem', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tipo: tipo, ids_ordenados: idsOrdenados }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.status !== "sucesso") {
                console.error(`Erro ao atualizar ordem de ${tipo}:`, data.mensagem);
            }
        })
        .catch((error) => {
            console.error('Erro de rede ao enviar ordem:', error);
        });
    }

    const categoriasContainer = document.getElementById('categorias-container');
    if (categoriasContainer) {
        new Sortable(categoriasContainer, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            handle: '.categoria-handle',
            onEnd: function(evt) {
                const categorias = Array.from(evt.to.children);
                const idsOrdenados = categorias.map(el => parseInt(el.dataset.categoriaId));
                enviarNovaOrdem('categoria', idsOrdenados);
            }
        });
    }

    document.querySelectorAll('.produtos-container').forEach(container => {
        new Sortable(container, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function(evt) {
                const produtos = Array.from(evt.to.children);
                const idsOrdenados = produtos.map(el => parseInt(el.dataset.id));
                enviarNovaOrdem('produto', idsOrdenados);
            }
        });
    });

    // --- GERENCIADOR DE CLIQUES DA PÁGINA (UNIFICADO) ---
    document.addEventListener('click', async function(event) {
        
        // Verificamos se o clique foi no botão de editar
        const editButton = event.target.closest('.btn-editar');
        if (editButton) {
            event.preventDefault(); // Impede o '#' na URL
            const produtoItem = editButton.closest('.produto-item');
            
            // Preenche o formulário com os dados do 'data-*'
            document.getElementById('id_produto').value = produtoItem.dataset.id;
            document.getElementById('nome_produto').value = produtoItem.dataset.nome;
            // Aplicando sua correção de camelCase:
            console.log("Valor Lido para Categoria:", produtoItem.dataset.categoriaId);
            console.log("Valor Lido para Preço Venda:", produtoItem.dataset.precoVenda);
            document.getElementById('categoria_produto').value = produtoItem.dataset.categoriaId; 
            document.getElementById('preco_venda').value = produtoItem.dataset.precoVenda;
            document.getElementById('preco_compra').value = produtoItem.dataset.precoCompra;

            // Limpa os campos de compra
            document.getElementById('quantidade').value = '';
            document.getElementById('nome_produto').focus();
        }

        // Verificamos se o clique foi no botão de histórico
        const historicoButton = event.target.closest('.btn-historico');
        if (historicoButton) {
            event.preventDefault();
            const produtoItem = historicoButton.closest('.produto-item');
            const idProduto = produtoItem.dataset.id;
            const nomeProduto = produtoItem.dataset.nome;

            modalTitulo.textContent = `Histórico de: ${nomeProduto}`;
            modalCorpo.innerHTML = '<p>Carregando...</p>';
            modal.classList.remove('hidden');

            try {
                const response = await fetch(`/api/historico_produto/${idProduto}`);
                if (!response.ok) throw new Error('Resposta da rede não foi OK');
                const historico = await response.json();

                modalCorpo.innerHTML = '';
                if (historico.length > 0) {
                    historico.forEach(entrada => {
                        const itemHtml = `
                            <div class="bg-white/10 p-3 rounded-lg">
                                <p><strong>Data:</strong> ${entrada.data}</p>
                                <p><strong>Quantidade:</strong> ${entrada.quantidade}</p>
                                <p><strong>Custo Unitário:</strong> R$ ${Number(entrada.custo).toFixed(2).replace('.', ',')}</p>
                            </div>
                        `;
                        modalCorpo.innerHTML += itemHtml;
                    });
                } else {
                    modalCorpo.innerHTML = '<p>Nenhuma entrada de estoque encontrada para este produto.</p>';
                }
            } catch (error) {
                console.error('Erro ao buscar histórico:', error);
                modalCorpo.innerHTML = '<p>Ocorreu um erro ao carregar o histórico.</p>';
            }
        }
    });

}); // --- FIM DO BLOCO DE SEGURANÇA 'DOMContentLoaded' ---
// --- VALIDAÇÃO DO FORMULÁRIO ---
const formProduto = document.getElementById('form-produto');
formProduto.addEventListener('submit', function(event) {
    // Pega os valores dos campos
    const idProduto = document.getElementById('id_produto').value;
    const nomeProduto = document.getElementById('nome_produto').value.trim();
    const categoriaProduto = document.getElementById('categoria_produto').value;
    const precoVenda = document.getElementById('preco_venda').value;
    const precoCompra = document.getElementById('preco_compra').value;
    const quantidade = document.getElementById('quantidade').value;
    
    let mensagemErro = '';
    
    if (!idProduto) {
        // NOVO PRODUTO - todos os campos são obrigatórios
        if (!nomeProduto) mensagemErro += '• Nome do produto é obrigatório\n';
        if (!categoriaProduto) mensagemErro += '• Categoria é obrigatória\n';
        if (!precoVenda) mensagemErro += '• Preço de venda é obrigatório\n';
        if (!precoCompra) mensagemErro += '• Preço de compra é obrigatório\n';
        if (!quantidade) mensagemErro += '• Quantidade é obrigatória\n';
    } else {
        // ATUALIZAÇÃO/ADIÇÃO DE ESTOQUE
        if (!precoVenda && !quantidade && !precoCompra) {
            mensagemErro = 'Para atualizar um produto, você precisa preencher:\n' +
                          '• Novo preço de venda, OU\n' +
                          '• Quantidade e preço de compra (para adicionar estoque)';
        } else if (quantidade && !precoCompra) {
            mensagemErro = '• Ao adicionar estoque, o preço de compra é obrigatório';
        } else if (!quantidade && precoCompra) {
            mensagemErro = '• Ao informar preço de compra, a quantidade é obrigatória';
        }
        
    }
    
    // Validação de valores numéricos
    if (precoVenda && (isNaN(precoVenda) || parseFloat(precoVenda) < 0)) {
        mensagemErro += '• Preço de venda deve ser um número válido maior ou igual a zero\n';
    }
    if (precoCompra && (isNaN(precoCompra) || parseFloat(precoCompra) < 0)) {
        mensagemErro += '• Preço de compra deve ser um número válido maior ou igual a zero\n';
    }
    if (quantidade && isNaN(quantidade)) {
        mensagemErro += '• Quantidade deve ser um número válido\n';
    }
    
    // Se houver erros, mostra o alerta e impede o envio
    if (mensagemErro) {
        event.preventDefault(); // Impede o envio do formulário
        alert('Por favor, corrija os seguintes erros:\n\n' + mensagemErro);
        return false;
    }
    
    // Se chegou aqui, o formulário está válido e será enviado
});

// --- FUNÇÃO PARA LIMPAR FORMULÁRIO ---
function limparFormulario() {
    document.getElementById('id_produto').value = '';
    document.getElementById('nome_produto').value = '';
    document.getElementById('categoria_produto').selectedIndex = 0;
    document.getElementById('preco_venda').value = '';
    document.getElementById('preco_compra').value = '';
    document.getElementById('quantidade').value = '';
}

</script>
    {# FIM DOS NOVOS SCRIPTS PARA DRAG-AND-DROP #}
    <div id="modal-historico" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="glass-container rounded-2xl p-6 w-full max-w-lg text-white">
            <div class="flex justify-between items-center border-b border-white/20 pb-3 mb-4">
                <h2 id="modal-titulo" class="text-2xl font-bold">Histórico de Compras</h2>
                <button id="modal-fechar" class="text-2xl hover:text-red-500">&times;</button>
            </div>
    
            <div id="modal-corpo" class="max-h-96 overflow-y-auto space-y-2">
                </div>
        </div>
    </div>
</body>
</html>